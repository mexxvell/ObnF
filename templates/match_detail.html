{% extends "layout_base.html" %}
{% block content %}
<div class="page page-match">
  <header class="match-header">
    <div class="team">
      <img src="/static/img/{{ match.team1|replace(' ', '_')|lower }}.png" alt="{{ match.team1 }}" onerror="this.style.display='none'">
      <div>{{ match.team1 }}</div>
    </div>
    <div class="score">
      <div class="score-value" id="score-{{ match.id }}">{{ match.score1 }} : {{ match.score2 }}</div>
      <div class="match-time">{{ match.datetime.strftime('%d.%m %H:%M') if match.datetime else '' }}</div>
    </div>
    <div class="team">
      <img src="/static/img/{{ match.team2|replace(' ', '_')|lower }}.png" alt="{{ match.team2 }}" onerror="this.style.display='none'">
      <div>{{ match.team2 }}</div>
    </div>
  </header>

  <section class="details">
    <h4>Форма</h4>
    <div class="forms">
      <div>{{ form1 }}</div>
      <div>{{ form2 }}</div>
    </div>

    <h4>Составы</h4>
    <div class="players">
      <div class="col">
        <h5>{{ match.team1 }}</h5>
        <ul>
          {% for p in players1 %}
            <li>{{ p.player }} — {{ p.position }} (#{{ p.number }})</li>
          {% else %}
            <li>-/-/-/-/-</li>
          {% endfor %}
        </ul>
      </div>
      <div class="col">
        <h5>{{ match.team2 }}</h5>
        <ul>
          {% for p in players2 %}
            <li>{{ p.player }} — {{ p.position }} (#{{ p.number }})</li>
          {% else %}
            <li>-/-/-/-/-</li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <div class="stream">
      {% if match.stream_url %}
        <h4>Трансляция</h4>
        <div class="video-wrap">
          <iframe src="{{ match.stream_url }}" allowfullscreen frameborder="0"></iframe>
        </div>
      {% endif %}
    </div>

    <div class="actions">
      <button id="subscribe-btn" data-match="{{ match.id }}" class="btn">{{ 'Отписаться' if subscribed else 'Подписаться' }}</button>

      {% if user_id == OWNER_ID %}
        <div class="admin-controls">
          <label>Редактировать счёт:</label>
          <input id="score1" type="number" value="{{ match.score1 }}" min="0">
          <input id="score2" type="number" value="{{ match.score2 }}" min="0">
          <button id="update-score" class="btn-primary" data-match="{{ match.id }}">Обновить</button>
        </div>
      {% endif %}
    </div>
  </section>
</div>

<script>
  // кнопка подписки
  document.addEventListener('DOMContentLoaded', ()=> {
    const subBtn = document.getElementById('subscribe-btn');
    if(subBtn){
      subBtn.addEventListener('click', async () => {
        const matchId = subBtn.dataset.match;
        const action = subBtn.textContent.includes('Отпис') ? 'unsubscribe' : 'subscribe';
        const url = action === 'subscribe' ? `/miniapp/subscribe/${matchId}` : `/miniapp/unsubscribe/${matchId}`;
        const res = await fetch(url, {method:'POST', headers: {'Content-Type':'application/json'}});
        const j = await res.json();
        if(j.success){
          subBtn.textContent = action === 'subscribe' ? 'Отписаться' : 'Подписаться';
          alert('Готово');
        } else alert('Ошибка');
      });
    }

    // обновление счёта (админ)
    const upd = document.getElementById('update-score');
    if(upd){
      upd.addEventListener('click', async ()=>{
        const mid = upd.dataset.match;
        const s1 = parseInt(document.getElementById('score1').value||0);
        const s2 = parseInt(document.getElementById('score2').value||0);
        const res = await fetch('/miniapp/update_score', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({match_id: mid, score1: s1, score2: s2})});
        const j = await res.json();
        if(j.success){
          document.getElementById('score-'+mid).textContent = s1 + ' : ' + s2;
          alert('Счёт обновлён и отправлены уведомления');
        } else {
          alert('Ошибка: ' + (j.error || '...'));
        }
      });
    }
  });
</script>
{% endblock %}
