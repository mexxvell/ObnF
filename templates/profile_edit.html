{% extends "layout_base.html" %}
{% block content %}
<div class="page profile-edit-page">
    <h2>Редактировать профиль</h2>
    
    <div class="profile-form">
        <div class="form-group">
            <label for="full_name">ФИО</label>
            <input type="text" id="full_name" class="form-input" value="{{ user.full_name or '' }}">
        </div>
        
        <div class="form-group">
            <label for="birth_date">Дата рождения</label>
            <input type="date" id="birth_date" class="form-input" value="{{ user.birth_date if user.birth_date else '' }}">
        </div>
        
        <div class="form-group">
            <label for="favorite_club">Любимый клуб</label>
            <select id="favorite_club" class="form-select">
                <option value="">Не выбрано</option>
                {% for club in clubs %}
                <option value="{{ club }}" {% if favorite_club == club %}selected{% endif %}>{{ club }}</option>
                {% endfor %}
            </select>
        </div>
        
        <button id="save-profile-btn" class="btn">Сохранить изменения</button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const saveBtn = document.getElementById('save-profile-btn');
    if (!saveBtn) return;
    
    saveBtn.addEventListener('click', () => {
        const fullName = document.getElementById('full_name').value;
        const birthDate = document.getElementById('birth_date').value;
        const favoriteClub = document.getElementById('favorite_club').value;
        
        // Валидация
        if (!fullName.trim()) {
            showNotification('Пожалуйста, введите ФИО', 'error');
            return;
        }
        
        // Отправка данных
        fetch('/miniapp/profile/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                full_name: fullName,
                birth_date: birthDate,
                favorite_club: favoriteClub
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Профиль успешно обновлен', 'success');
                
                // Через 1.5 секунды возвращаемся на страницу профиля
                setTimeout(() => {
                    window.location.href = '/miniapp/profile';
                }, 1500);
            } else {
                showNotification('Ошибка при сохранении профиля', 'error');
            }
        })
        .catch(error => {
            console.error('Error saving profile:', error);
            showNotification('Произошла ошибка. Попробуйте позже.', 'error');
        });
    });
    
    function showNotification(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type} show`;
        toast.innerHTML = `
            <div class="toast-content">
                <span class="toast-message">${message}</span>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 300);
        }, 3000);
    }
});
</script>
{% endblock %}